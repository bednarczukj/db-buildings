# API Endpoint: POST /api/v1/buildings

## Opis

Endpoint s≈Çu≈ºƒÖcy do tworzenia nowego budynku w bazie danych. Wymaga podania wszystkich wymaganych p√≥l zgodnych ze strukturƒÖ TERYT oraz koordynat√≥w geograficznych.

## URL

```
POST /api/v1/buildings
```

## Headers

| Header       | Wymagany | Warto≈õƒá          |
| ------------ | -------- | ---------------- |
| Content-Type | Tak      | application/json |

## Request Body

### Wymagane pola

| Pole               | Typ    | Opis                                    | Walidacja                                  |
| ------------------ | ------ | --------------------------------------- | ------------------------------------------ |
| `voivodeship_code` | string | Kod wojew√≥dztwa                         | Dok≈Çadnie 7 znak√≥w, musi istnieƒá w bazie   |
| `district_code`    | string | Kod powiatu                             | Dok≈Çadnie 7 znak√≥w, musi istnieƒá w bazie   |
| `community_code`   | string | Kod gminy                               | Dok≈Çadnie 7 znak√≥w, musi istnieƒá w bazie   |
| `city_code`        | string | Kod miejscowo≈õci                        | Dok≈Çadnie 7 znak√≥w, musi istnieƒá w bazie   |
| `street_code`      | string | Kod ulicy                               | Min. 1 znak                                |
| `building_number`  | string | Numer budynku                           | Min. 1 znak                                |
| `location`         | object | Koordynaty geograficzne (GeoJSON Point) | Patrz struktura poni≈ºej                    |
| `provider_id`      | number | ID dostawcy us≈Çug                       | Liczba ca≈Çkowita > 0, musi istnieƒá w bazie |

### Opcjonalne pola

| Pole                 | Typ    | Opis                  | Walidacja                                               |
| -------------------- | ------ | --------------------- | ------------------------------------------------------- |
| `city_district_code` | string | Kod dzielnicy/osiedla | Dok≈Çadnie 7 znak√≥w, je≈õli podano - musi istnieƒá w bazie |

### Struktura `location` (GeoJSON Point)

```json
{
  "type": "Point",
  "coordinates": [longitude, latitude]
}
```

**Uwaga:** Kolejno≈õƒá to `[longitude, latitude]` zgodnie ze standardem GeoJSON (RFC 7946).

**Zakresy dla Polski:**

- `longitude` (d≈Çugo≈õƒá geograficzna): 14.1 do 24.1
- `latitude` (szeroko≈õƒá geograficzna): 49.0 do 54.8

## Przyk≈Çadowe ≈ºƒÖdania

### 1. Podstawowe ≈ºƒÖdanie (minimalne wymagane pola)

```bash
curl -X POST "http://localhost:4321/api/v1/buildings" \
  -H "Content-Type: application/json" \
  -d '{
    "voivodeship_code": "1465011",
    "district_code": "1465011",
    "community_code": "1465011",
    "city_code": "0918123",
    "street_code": "10270",
    "building_number": "42A",
    "location": {
      "type": "Point",
      "coordinates": [21.0122, 52.2297]
    },
    "provider_id": 1
  }'
```

### 2. ≈ªƒÖdanie z dzielnicƒÖ miasta

```bash
curl -X POST "http://localhost:4321/api/v1/buildings" \
  -H "Content-Type: application/json" \
  -d '{
    "voivodeship_code": "1465011",
    "district_code": "1465011",
    "community_code": "1465011",
    "city_code": "0918123",
    "city_district_code": "0918001",
    "street_code": "10270",
    "building_number": "15",
    "location": {
      "type": "Point",
      "coordinates": [21.0122, 52.2297]
    },
    "provider_id": 2
  }'
```

### 3. Budynek w Krakowie

```bash
curl -X POST "http://localhost:4321/api/v1/buildings" \
  -H "Content-Type: application/json" \
  -d '{
    "voivodeship_code": "1261011",
    "district_code": "1261011",
    "community_code": "1261011",
    "city_code": "0950867",
    "street_code": "12345",
    "building_number": "10B",
    "location": {
      "type": "Point",
      "coordinates": [19.9450, 50.0647]
    },
    "provider_id": 1
  }'
```

## Odpowiedzi

### Sukces (201 Created)

Budynek zosta≈Ç pomy≈õlnie utworzony.

```json
{
  "id": 123,
  "voivodeship_code": "1465011",
  "district_code": "1465011",
  "community_code": "1465011",
  "city_code": "0918123",
  "city_district_code": null,
  "street_code": "10270",
  "building_number": "42A",
  "location": "{\"type\":\"Point\",\"coordinates\":[21.0122,52.2297]}",
  "provider_id": 1,
  "status": "active",
  "created_at": "2024-10-11T10:30:00Z",
  "updated_at": "2024-10-11T10:30:00Z",
  "created_by": "00000000-0000-0000-0000-000000000000",
  "updated_by": "00000000-0000-0000-0000-000000000000"
}
```

#### Pola automatyczne

NastƒôpujƒÖce pola sƒÖ ustawiane automatycznie:

- `id` - generowany przez bazƒô (auto-increment)
- `status` - zawsze "active" dla nowego budynku
- `created_at` - timestamp utworzenia
- `updated_at` - timestamp utworzenia (taki sam jak created_at)
- `created_by` - UUID u≈ºytkownika (obecnie DEFAULT_USER_ID)
- `updated_by` - UUID u≈ºytkownika (obecnie DEFAULT_USER_ID)

### B≈ÇƒÖd walidacji (400 Bad Request)

Zwracany gdy request body jest nieprawid≈Çowy.

#### Przypadek 1: BrakujƒÖce wymagane pole

```json
{
  "error": "Validation error",
  "details": [
    {
      "code": "invalid_type",
      "expected": "string",
      "received": "undefined",
      "path": ["street_code"],
      "message": "Required"
    }
  ]
}
```

#### Przypadek 2: Nieprawid≈Çowa d≈Çugo≈õƒá kodu TERYT

```json
{
  "error": "Validation error",
  "details": [
    {
      "code": "too_small",
      "minimum": 7,
      "type": "string",
      "inclusive": true,
      "exact": true,
      "message": "Voivodeship code must be exactly 7 characters",
      "path": ["voivodeship_code"]
    }
  ]
}
```

#### Przypadek 3: Nieprawid≈Çowy format GeoJSON

```json
{
  "error": "Validation error",
  "details": [
    {
      "code": "invalid_literal",
      "expected": "Point",
      "received": "Polygon",
      "path": ["location", "type"],
      "message": "Invalid literal value, expected \"Point\""
    }
  ]
}
```

#### Przypadek 4: Nieprawid≈Çowy JSON

```json
{
  "error": "Invalid JSON",
  "message": "Request body must be valid JSON"
}
```

### Nie znaleziono (404 Not Found)

Zwracany gdy kt√≥ra≈õ z referencji nie istnieje w bazie.

#### NieistniejƒÖcy kod wojew√≥dztwa

```json
{
  "error": "Not found",
  "message": "Invalid voivodeship_code: 9999999"
}
```

#### NieistniejƒÖcy provider_id

```json
{
  "error": "Not found",
  "message": "Invalid provider_id: 99999"
}
```

**Mo≈ºliwe komunikaty:**

- `Invalid voivodeship_code: {code}`
- `Invalid district_code: {code}`
- `Invalid community_code: {code}`
- `Invalid city_code: {code}`
- `Invalid city_district_code: {code}`
- `Invalid provider_id: {id}`

### Konflikt (409 Conflict)

Zwracany gdy budynek o identycznych parametrach ju≈º istnieje.

```json
{
  "error": "Conflict",
  "message": "A building with these parameters already exists"
}
```

**Unikalno≈õƒá budynku jest okre≈õlana przez:**

- voivodeship_code
- district_code
- community_code
- city_code
- city_district_code (je≈õli podano)
- street_code
- building_number
- status = "active"

**Uwaga:** Mo≈ºna utworzyƒá budynek o tych samych parametrach je≈õli poprzedni ma status "deleted".

### Nieprzetworzona encja (422 Unprocessable Entity)

Zwracany gdy koordynaty sƒÖ poza zakresem Polski.

```json
{
  "error": "Unprocessable Entity",
  "message": "Coordinates must be within Poland bounds (lng: 14.1-24.1, lat: 49.0-54.8)",
  "details": [
    {
      "code": "custom",
      "message": "Coordinates must be within Poland bounds (lng: 14.1-24.1, lat: 49.0-54.8)",
      "path": ["location", "coordinates"]
    }
  ]
}
```

### B≈ÇƒÖd serwera (500 Internal Server Error)

Zwracany przy nieoczekiwanych b≈Çƒôdach serwera lub bazy danych.

```json
{
  "error": "Internal server error",
  "message": "Failed to create building: [error details]"
}
```

## Bezpiecze≈Ñstwo

### Uwierzytelnianie

- Obecnie endpoint wykorzystuje tymczasowy `DEFAULT_USER_ID`
- W przysz≈Ço≈õci zostanie zaimplementowane uwierzytelnianie JWT
- Token bƒôdzie przekazywany w HttpOnly Secure cookies

### Autoryzacja

- Row Level Security (RLS) na poziomie Supabase
- Wymagana rola `WRITE` lub `ADMIN` do tworzenia budynk√≥w
- Rola `READ` nie ma uprawnie≈Ñ do tworzenia

### Walidacja

- Wszystkie pola walidowane przez Zod przed wys≈Çaniem do bazy
- Walidacja istnienia wszystkich referencji (kody TERYT, provider_id)
- Walidacja zakresu koordynat√≥w geograficznych
- Zabezpieczenie przed SQL injection (Supabase SDK z parametrami)
- Sprawdzenie unikalno≈õci przed utworzeniem

## Wydajno≈õƒá

### Liczba zapyta≈Ñ do bazy

Przy tworzeniu jednego budynku wykonywanych jest:

- 5-6 zapyta≈Ñ SELECT (walidacja referencji)
- 1 zapytanie SELECT (sprawdzenie unikalno≈õci)
- 1 zapytanie INSERT (utworzenie budynku)

**Razem:** 7-8 zapyta≈Ñ na jedno ≈ºƒÖdanie

### Optymalizacje

- ‚úÖ Walidacja referencji wykonywana r√≥wnolegle (gdzie mo≈ºliwe)
- ‚úÖ Sprawdzenie unikalno≈õci przed INSERT
- üìù Do rozwa≈ºenia: cache dla kod√≥w TERYT
- üìù Do rozwa≈ºenia: foreign key constraints zamiast walidacji w aplikacji

## Przyk≈Çadowe scenariusze u≈ºycia

### Scenariusz 1: Dodanie budynku z frontendu

```javascript
async function createBuilding(buildingData) {
  try {
    const response = await fetch("/api/v1/buildings", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(buildingData),
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || "Failed to create building");
    }

    const newBuilding = await response.json();
    console.log("Building created:", newBuilding);
    return newBuilding;
  } catch (error) {
    console.error("Error:", error);
    throw error;
  }
}

// U≈ºycie
const result = await createBuilding({
  voivodeship_code: "1465011",
  district_code: "1465011",
  community_code: "1465011",
  city_code: "0918123",
  street_code: "10270",
  building_number: "42A",
  location: {
    type: "Point",
    coordinates: [21.0122, 52.2297],
  },
  provider_id: 1,
});
```

### Scenariusz 2: Obs≈Çuga b≈Çƒôd√≥w walidacji

```javascript
try {
  const response = await fetch("/api/v1/buildings", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(buildingData),
  });

  if (response.status === 400) {
    const error = await response.json();
    // Wy≈õwietl szczeg√≥≈Çy b≈Çƒôd√≥w walidacji u≈ºytkownikowi
    error.details.forEach((detail) => {
      console.error(`Pole ${detail.path.join(".")}: ${detail.message}`);
    });
  } else if (response.status === 409) {
    // Budynek ju≈º istnieje
    alert("Ten budynek ju≈º znajduje siƒô w bazie danych");
  } else if (response.status === 404) {
    // NieistniejƒÖca referencja
    const error = await response.json();
    alert(error.message);
  } else if (response.status === 422) {
    // Koordynaty poza zakresem
    alert("Podane koordynaty sƒÖ poza terytorium Polski");
  }
} catch (error) {
  console.error("Network error:", error);
}
```

### Scenariusz 3: Wykorzystanie mock√≥w w testach

```javascript
import { mockCreateBuildingPayloadWarsaw } from "@/lib/mocks";

// Test endpoint POST
describe("POST /api/v1/buildings", () => {
  it("should create a new building with valid data", async () => {
    const response = await fetch("/api/v1/buildings", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(mockCreateBuildingPayloadWarsaw),
    });

    expect(response.status).toBe(201);
    const building = await response.json();
    expect(building.id).toBeDefined();
    expect(building.status).toBe("active");
  });
});
```

## Testowanie

### Dostƒôpne mocki

```typescript
import {
  mockCreateBuildingPayloadWarsaw, // Prawid≈Çowy payload dla Warszawy
  mockCreateBuildingPayloadKrakow, // Prawid≈Çowy payload dla Krakowa
  mockInvalidPayloadMissingFields, // Brak wymaganych p√≥l (400)
  mockInvalidPayloadOutOfBounds, // Koordynaty poza PolskƒÖ (422)
  mockInvalidPayloadWrongCodeLength, // Z≈Çy rozmiar kodu TERYT (400)
  mockInvalidPayloadBadGeoJSON, // Z≈Çy format GeoJSON (400)
  mockPayloadNonExistentVoivodeship, // NieistniejƒÖce wojew√≥dztwo (404)
  mockPayloadNonExistentProvider, // NieistniejƒÖcy provider (404)
  generateMockCreatePayload, // Funkcja generujƒÖca losowe payloady
} from "@/lib/mocks";
```

### Scenariusze testowe

| #   | Scenariusz                                 | Oczekiwany rezultat      |
| --- | ------------------------------------------ | ------------------------ |
| 1   | Poprawne dane (wszystkie wymagane pola)    | 201 Created              |
| 2   | Poprawne dane + city_district_code         | 201 Created              |
| 3   | Brak wymaganego pola (np. street_code)     | 400 Bad Request          |
| 4   | Nieprawid≈Çowa d≈Çugo≈õƒá kodu TERYT           | 400 Bad Request          |
| 5   | Nieprawid≈Çowy format GeoJSON               | 400 Bad Request          |
| 6   | Nieprawid≈Çowy JSON (syntax error)          | 400 Bad Request          |
| 7   | Koordynaty poza PolskƒÖ                     | 422 Unprocessable Entity |
| 8   | NieistniejƒÖcy voivodeship_code             | 404 Not Found            |
| 9   | NieistniejƒÖcy provider_id                  | 404 Not Found            |
| 10  | Duplikat budynku (ten sam aktywny)         | 409 Conflict             |
| 11  | Utworzenie po usuniƒôciu (deleted ‚Üí active) | 201 Created              |

## PowiƒÖzane endpointy

- `GET /api/v1/buildings` - Lista budynk√≥w ([dokumentacja](./api-endpoint-buildings-get.md))
- `GET /api/v1/buildings/:id` - Pojedynczy budynek (TODO)
- `PUT /api/v1/buildings/:id` - Aktualizacja budynku (TODO)
- `DELETE /api/v1/buildings/:id` - Usuniƒôcie budynku (TODO)

## Changelog

| Data       | Wersja | Zmiany                    |
| ---------- | ------ | ------------------------- |
| 2024-10-11 | 1.0    | Pierwsza wersja endpointa |

## Wsparcie

W przypadku problem√≥w:

1. Sprawd≈∫ logi serwera dla szczeg√≥≈Çowych informacji o b≈Çƒôdach
2. Zweryfikuj poprawno≈õƒá danych wed≈Çug dokumentacji
3. Upewnij siƒô, ≈ºe wszystkie kody TERYT i provider_id istniejƒÖ w bazie
4. Sprawd≈∫ czy koordynaty sƒÖ w formacie [longitude, latitude] i w zakresie Polski
